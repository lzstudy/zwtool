#!/bin/bash

# 通用路径
ROOT_PATH=$PATH_ZWTL_ROOT
CORE_PATH=$ROOT_PATH/core/zwpp

# 专用文件
THIS_FILE=$ROOT_PATH/zwpp
LINK_FILE=$PATH_ZWTL_INST/pp

# 默认文件
DEFAULT_FILE=$CORE_PATH/current

########################################################################################################
# 帮助选项
########################################################################################################
function print_usage()
{
    echo "cmd           [arg]            [val]     description"
    echo "----------    -------------    ------    --------------"
	echo "pp                             file      look file note"
}

########################################################################################################
# 查看文件
########################################################################################################
function look_file()
{
	if [ $# = 1 ];then
		ls -p $CORE_PATH
	else
		ls -p $CORE_PATH/$2
	fi
}

########################################################################################################
# zwpp边界
########################################################################################################
function zwpp_edit()
{
	RES=$(find $CORE_PATH -name $2)
	vi $RES
}

########################################################################################################
# 文件提示 或 搜索
########################################################################################################
function prompt_file()
{
	cd ${CORE_PATH}
	RES=$(find -name $1)
	FILE=$CORE_PATH/$RES

	if [ -f $FILE ]; then
		cat $FILE						
	else
		cd $CORE_PATH
		grep --color=auto $1 * -nr
	fi
}

########################################################################################################
# 提示文件 + 上下文
########################################################################################################
function prompt_file_context()
{
	cd ${CORE_PATH}
	RES=$(find -name $1)

	if [[ $# == 2 ]]; then
		grep --color=auto $2 $RES -A 5
	else
		grep --color=auto $2 $RES -A $3
	fi
}

########################################################################################################
# 根据情况提示
########################################################################################################
function do_prompt()
{
	case $# in
		1) prompt_file $@ ;;
		*) prompt_file_context $@ ;;
	esac
}

########################################################################################################
# 程序入口
########################################################################################################
function zwpp_entry()
{
	if [ $# = 0 ];then
		cat $DEFAULT_FILE
		exit 1
	fi

	case $1 in
		-h)    print_usage ;;
		.)     cat $PWD/zw.pp ;;
		-init) ln -s $THIS_FILE $LINK_FILE 2> /dev/null ;;
		-l)    look_file $@ ;;
		-ls)   look_file $@ ;;
		-cd)   cd $CORE_PATH ;;
		-e)    zwpp_edit $@ ;;
		-edit) vi $THIS_FILE ;;
		*)     do_prompt $@ ;;
	esac
}

zwpp_entry $@
